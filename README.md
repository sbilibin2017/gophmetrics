# Gophmetrics

## О проекте

**Gophmetrics** — это система сбора, передачи и хранения метрик, состоящая из двух частей: сервера и агента.

Проект реализован в рамках трека **"Продвинутый Go-разработчик"** Яндекс Практикума.  

Цель — создание полнофункциональной, надёжной и расширяемой системы мониторинга метрик с использованием современных технологий и лучших практик разработки на Go.

---

## Основные возможности

### Серверная часть
- REST API для приёма и отдачи метрик двух типов: gauge (float64) и counter (int64)  
- Поддержка обновления метрик и получения значений по имени  
- Отдача списка всех метрик через HTML-страницу  
- Поддержка работы с JSON API и gzip сжатием  
- Хранение метрик в памяти, файле или PostgreSQL с миграциями  
- Расширенный функционал: алертинг, мониторинг, логирование, проверка доверенных подсетей  
- Поддержка HTTPS и асимметричного шифрования  
- API расширяется для gRPC и пакетной обработки метрик  
- Конфигурирование через флаги, переменные окружения и JSON-файлы  
- Корректное завершение с сохранением данных  
- Механизм подписи данных с SHA256

### Агент
- HTTP клиент, собирающий метрики из runtime Go (runtime package) и системные (gopsutil)  
- Отправка метрик на сервер с заданной периодичностью и батчами  
- Поддержка gzip сжатия и подписи запросов  
- Реализация ограничения количества параллельных запросов (rate limiting)  
- Разделение сбора и отправки метрик в отдельные горутины  
- Обработка ошибок с повторными попытками (retry с экспоненциальным бэком)

---

## Технологии и архитектура

- **Язык:** Go — высокая производительность и эффективное многопоточность  
- **Протоколы:** HTTP REST с поддержкой JSON и gzip, gRPC  
- **Хранение:** память, файл, PostgreSQL с автоматическим созданием таблиц и миграциями  
- **Безопасность:** подпись данных SHA256, TLS/HTTPS, асимметричное шифрование сообщений  
- **Логирование:** интеграция с внешними логгерами (zerolog, zap, logrus)  
- **Конфигурация:** флаги командной строки, переменные окружения, JSON-конфигурационные файлы  
- **Тестирование:** юнит-тесты, примеры использования, статический анализ с custom multichecker  
- **Профилирование:** сбор pprof для анализа производительности и памяти

---

## Дополнительные возможности

- Расширяемость и поддержка нескольких API (HTTP, gRPC)  
- Продвинутый мониторинг с алертами и логированием  
- Встроенная проверка IP-адресов клиентов по доверенным подсетям  
- Поддержка корректного graceful shutdown  
- Наличие статического анализатора кода и строгих правил кодстайла

---

## Почему именно так?

- Go позволяет легко реализовать высокопроизводительный и устойчивый к ошибкам сервер с параллельной обработкой  
- Разделение агента и сервера позволяет гибко масштабировать и адаптировать систему под разные сценарии  
- Поддержка современных технологий (gRPC, TLS, gzip, JSON) делает проект универсальным и совместимым с большинством инструментов  
- Внимание к безопасности и подписыванию данных гарантирует защиту целостности метрик  
- Использование стандартных практик конфигурации и логирования облегчает эксплуатацию и сопровождение

---

| Компонент | Описание |
|-----------|----------|
| **Сервер** | Предоставляет REST API для работы с метриками: обновление метрик, получение значений конкретных метрик, получение списка всех метрик. Принимает и хранит метрики двух типов — gauge (float64) и counter (int64). |
| **Агент**  | HTTP-клиент, который регулярно собирает метрики из рантайма Go (пакет `runtime`) и дополнительные метрики, а затем отправляет их на сервер по HTTP. |

---

## Итерации 

| Итерация | Описание                                                                                       |
|----------|------------------------------------------------------------------------------------------------|
| iter1    | Разработка сервера для сбора рантайм-метрик. Сервер принимает и хранит метрики двух типов (gauge и counter) по HTTP POST запросам, в формате `/update/<тип>/<имя>/<значение>`. Обрабатывает корректность данных и возвращает соответствующие HTTP статусы. Агент еще не реализован. |
| iter2    | Разработка агента — HTTP-клиента, который собирает рантайм-метрики из пакета runtime (типы gauge и counter) и отправляет их на сервер по HTTP методом POST с заданными интервалами обновления (pollInterval=2с) и отчёта (reportInterval=10с). Добавлены метрики PollCount (counter) и RandomValue (gauge). |
| iter3    | Переписать сервер, используя внешний HTTP-фреймворк или роутер совместимый с net/http. Добавить GET обработчик `/value/<тип>/<имя>`, который возвращает значение метрики или 404, если метрика не найдена. Добавить корневой GET `/` для отдачи HTML-страницы со списком всех метрик. Использовать интерфейсы MemStorage для доступа к данным. |
| iter4    | Добавлена поддержка флагов командной строки для сервера и агента: `-a` — адрес HTTP-сервера (по умолчанию localhost:8080), `-r` — reportInterval для агента (по умолчанию 10с), `-p` — pollInterval для агента (по умолчанию 2с). При передаче неизвестных флагов приложение завершается с ошибкой. |
| iter5    | Реализовать механизм алертинга и мониторинга метрик. Добавить функционал для уведомлений при достижении определённых порогов метрик и улучшить систему логирования и обработки ошибок. |
| iter6    | Добавить логирование запросов и ответов на сервере через middleware. Логи содержат URI, метод, время обработки запроса, код статуса и размер ответа. Использовать сторонний пакет логирования (например, zerolog, zap или logrus) на уровне Info. |
| iter7    | Расширить API сервера для приёма и выдачи метрик в формате JSON с использованием структуры Metrics и Content-Type: application/json. Реализовать POST `/update/` и `/value/` для JSON обмена. Перевести агента на новый JSON API. |
| iter8    | Добавить поддержку gzip сжатия в сервер и агент. Агент должен отправлять сжатые gzip данные. Сервер — принимать gzip запросы при наличии заголовка Content-Encoding и отдавать gzip ответы клиентам, которые указывают Accept-Encoding. Сжатие работает для типов application/json и text/html. |
| iter9    | Добавить периодическое сохранение метрик сервера в файл с заданным интервалом (флаг -i / env STORE_INTERVAL), загрузку сохранённых значений при старте (флаг -r / env RESTORE), и указание файла для хранения (флаг -f / env FILE_STORAGE_PATH). Приоритет: env > флаг > по умолчанию. При штатном завершении данные сохраняются. |
| iter10   | Добавить подключение к PostgreSQL (версии ≥ 10) с конфигурацией через переменную окружения DATABASE_DSN или флаг -d. Реализовать хендлер GET /ping для проверки подключения к базе: возвращает 200 OK при успешном соединении, 500 Internal Server Error при ошибке. Использовать одну из библиотек: database/sql, pgx, lib/pq, или sqlx. |
| iter11   | Переписать сервер для хранения метрик в PostgreSQL с автоматическим созданием необходимых таблиц (рекомендуемый тип для gauge — double precision). При отсутствии DATABASE_DSN или пустом значении использовать по приоритету: файл (если задан) или память. |
| iter12   | Добавить на сервер новый POST /updates/ хендлер, принимающий в теле JSON массив метрик ([]Metrics). Агент должен поддерживать новый API — отправлять метрики батчами с gzip-сжатием. Обратная совместимость сохранена. Изменения в базе — в одной транзакции, без гонок. |
| iter13   | Добавить обработку retriable-ошибок в агенте и сервере. Реализовать повторные попытки выполнения операций при временных ошибках (сети, базы данных, файловой системы) с ограничением в 3 попытки и экспоненциальным увеличением интервала между ними (1с, 3с, 5с). Использовать pgerrcode для определения ошибок PostgreSQL класса Connection Exception. |
| iter14   | Реализовать механизм подписи данных с использованием SHA256. Добавить флаг -k и переменную окружения KEY для передачи ключа. Агент при наличии ключа вычисляет хеш от тела запроса с ключом и отправляет в заголовке HashSHA256. Сервер при наличии ключа проверяет корректность хеша входящих запросов, возвращая 400 при несовпадении, и добавляет хеш в заголовок ответа HashSHA256. |
| iter15   | Перепланировать архитектуру агента: разделить сбор метрик (опрос runtime) и их отправку на сервер в разные горутины. Ограничить количество параллельных исходящих HTTP-запросов с помощью параметра -l и переменной окружения RATE_LIMIT (реализовать через worker pool). Добавить отдельную горутину для сбора метрик типа gauge из пакета gopsutil (TotalMemory, FreeMemory, CPUutilization1 по количеству CPU во время выполнения). |
| iter16   | Добавить бенчмарки для ключевых компонентов проекта (сокращения URL и сбора метрик). Провести анализ использования памяти с помощью pprof: сохранить базовый профиль (profiles/base.pprof), выявить и оптимизировать неэффективные участки кода, затем сохранить оптимизированный профиль (profiles/result.pprof). |
| iter17   | Отформатировать весь проект с помощью gofmt или goimports. Проверить, что все исходные файлы корректно отформатированы и соответствуют стандартам оформления кода в Go. |
| iter18   | Добавить документацию в формате godoc к основным экспортируемым методам, структурам, интерфейсам и переменным проекта, включая хендлеры и публичные API. Реализовать примерные тесты с примерами использования (example_test.go) для ключевых эндпоинтов практического трека, чтобы продемонстрировать работу с API. |
| iter19   | Создать multichecker — набор статических анализаторов, включающий: стандартные анализаторы из golang.org/x/tools/go/analysis/passes, все SA-анализаторы из staticcheck.io, минимум один анализатор из других классов staticcheck.io, и как минимум два публичных сторонних анализатора по выбору. Реализовать собственный анализатор, запрещающий прямой вызов os.Exit в функции main пакета main. Добавить его в multichecker. Переписать код проекта для соответствия этому правилу. Разместить multichecker в каталоге cmd/staticlint с подробной godoc-документацией, описывающей запуск multichecker и назначение каждого анализатора. Код проекта должен успешно проходить анализ созданным multichecker. |
| iter20   | Добавить флаги сборки |
| iter21   | Добавить поддержку HTTPS в сервере (запуск с TLS при флаге -s или переменной ENABLE_HTTPS). В агент и сервер добавить асимметричное шифрование сообщений с использованием ключей, путь к которым передаётся через флаг -crypto-key или переменную CRYPTO_KEY. Агент шифрует данные публичным ключом, сервер расшифровывает приватным. |
| iter22   | Добавить возможность конфигурации сервера и агента через JSON-файл. Поддержать все текущие опции приложения. Имя файла задаётся через флаг -c/-config или переменную окружения CONFIG. Значения из файла имеют меньший приоритет, чем флаги или переменные окружения. Формат JSON для сервера и агента включает соответствующие параметры адреса, интервалов, путей к файлам, ключей и пр. |
| iter23   | Реализовать корректное завершение агента и сервера по сигналам syscall.SIGTERM, syscall.SIGINT, syscall.SIGQUIT. Агент должен гарантировать отправку всех метрик, находящихся в обработке, перед остановкой. Сервер должен корректно сохранить все несохранённые данные перед завершением работы. |
| iter24   | Добавить в конфигурационный JSON сервера поле trusted_subnet (string, env TRUSTED_SUBNET, флаг -t) для задания CIDR доверенной подсети. Агент при отправке метрик добавляет заголовок X-Real-IP с IP-адресом хоста. Сервер проверяет, что IP из X-Real-IP входит в доверенную подсеть, иначе возвращает 403 Forbidden. Если trusted_subnet пустой, проверка не применяется. |
| iter25   | Добавить поддержку обмена данными между сервером и агентом по протоколу gRPC. Обеспечить конфигурирование gRPC-сервера и клиента с возможностью задания параметров аналогично HTTP-конфигурациям. Реализовать все основные функции обмена метриками через gRPC. |

---

## Структура 

```
.
├── api                         # API спецификации и описание интерфейсов
│   ├── grpc                    # gRPC спецификации
│   │   └── metric.proto        # Protobuf описание для метрик в gRPC
│   └── http                    # HTTP API и документация
│       ├── docs.go            # HTTP документация в виде кода (например, генерация docs)
│       ├── swagger.json       # Swagger JSON спецификация HTTP API
│       └── swagger.yaml       # Swagger YAML спецификация HTTP API
├── cmd                         # Точка входа для разных исполняемых файлов (команд)
│   ├── agent                   # Агент (клиентская часть)
│   │   └── main.go             # Основной файл запуска агента
│   ├── server                  # Серверная часть
│   │   └── main.go             # Основной файл запуска сервера
│   └── staticlint              # Статический анализатор кода
│       ├── analyzers           # Анализаторы для статического анализа
│       │   └── noexit.go       # Анализатор, запрещающий использование os.Exit
│       └── main.go             # Точка входа для staticlint
├── go.mod                      # Модульные зависимости Go проекта
├── go.sum                      # Контрольные суммы зависимостей
├── internal                   # Внутренние пакеты проекта, не экспортируются вне модуля
│   ├── agent                  # Логика агента
│   │   ├── agent.go            # Основной код агента
│   │   ├── agent_mock.go       # Моки для тестирования агента
│   │   └── agent_test.go       # Тесты для агента
│   ├── configs                # Конфигурации проекта
│   │   ├── address             # Конфигурация адресов
│   │   │   ├── address.go      # Код для работы с адресами
│   │   │   └── address_test.go # Тесты для адресов
│   │   ├── compressor          # Конфигурация компрессоров
│   │   │   ├── compressor.go   # Логика компрессии
│   │   │   └── compressor_test.go # Тесты компрессора
│   │   ├── cryptor             # Конфигурация шифрования
│   │   │   ├── cryptor.go      # Логика шифрования
│   │   │   └── cryptor_test.go # Тесты шифрования
│   │   ├── db                  # Конфигурация базы данных
│   │   │   ├── db.go           # Работа с БД
│   │   │   └── db_test.go      # Тесты БД
│   │   ├── hasher              # Конфигурация хеширования
│   │   │   ├── hasher.go       # Логика хеширования
│   │   │   └── hasher_test.go  # Тесты хеширования
│   │   └── transport           # Конфигурация транспорта
│   │       ├── grpc            # Конфигурация gRPC клиента
│   │       │   ├── client.go   # gRPC клиент
│   │       │   └── client_test.go # Тесты gRPC клиента
│   │       └── http            # Конфигурация HTTP клиента
│   │           ├── client.go   # HTTP клиент
│   │           └── client_test.go # Тесты HTTP клиента
│   ├── facades                # Фасады для взаимодействия с сервисами
│   │   ├── grpc                # Фасады gRPC
│   │   │   ├── metric.go       # Методы фасада для метрик (gRPC)
│   │   │   └── metric_test.go  # Тесты фасада gRPC
│   │   └── http                # Фасады HTTP
│   │       ├── metric.go       # Методы фасада для метрик (HTTP)
│   │       ├── metric_mock.go  # Моки фасада HTTP
│   │       └── metric_test.go  # Тесты фасада HTTP
│   ├── handlers               # Обработчики запросов
│   │   ├── grpc                # gRPC обработчики
│   │   │   ├── metric.go       # Обработчик метрик gRPC
│   │   │   ├── metric_mock.go  # Моки для gRPC обработчиков
│   │   │   └── metric_test.go  # Тесты gRPC обработчиков
│   │   └── http                # HTTP обработчики
│   │       ├── metric.go       # Обработчик метрик HTTP
│   │       ├── metric_mock.go  # Моки HTTP обработчиков
│   │       └── metric_test.go  # Тесты HTTP обработчиков
│   ├── middlewares            # HTTP middleware для дополнительной логики
│   │   └── http                # HTTP middleware
│   │       ├── gzip.go         # Middleware для gzip сжатия
│   │       ├── gzip_test.go    # Тесты gzip middleware
│   │       ├── hash.go         # Middleware для хеширования
│   │       ├── hash_mock.go    # Моки для hash middleware
│   │       ├── hash_test.go    # Тесты hash middleware
│   │       ├── logging.go      # Middleware для логирования
│   │       ├── logging_test.go # Тесты logging middleware
│   │       ├── trusted_subnet.go # Middleware для проверки доверенных подсетей
│   │       └── trusted_subnet_test.go # Тесты trusted subnet middleware
│   ├── models                 # Определения моделей данных
│   │   └── metrics.go          # Модель данных метрик
│   ├── repositories           # Репозитории для хранения данных
│   │   ├── db                  # Репозиторий на базе БД
│   │   │   ├── metric.go       # Работа с метриками в БД
│   │   │   └── metric_test.go  # Тесты репозитория БД
│   │   ├── file                # Репозиторий с хранением в файлах
│   │   │   ├── metric.go       # Метрики, сохранённые в файлах
│   │   │   └── metric_test.go  # Тесты файлового репозитория
│   │   └── memory              # Репозиторий в памяти
│   │       ├── metric.go       # Метрики в памяти
│   │       └── metric_test.go  # Тесты памяти
│   ├── services               # Бизнес-логика сервиса
│   │   ├── metric.go           # Сервис для работы с метриками
│   │   ├── metric_mock.go      # Моки для сервисов метрик
│   │   └── metric_test.go      # Тесты бизнес-логики метрик
│   └── worker                 # Фоновая работа и воркеры
│       ├── worker.go           # Основной код воркера
│       ├── worker_mock.go      # Моки воркера
│       └── worker_test.go      # Тесты воркера
├── Makefile                   # Makefile для сборки, тестирования, запуска
├── migrations                 # SQL миграции базы данных
│   └── 20250806013842_create_metrics_table.sql # Создание таблицы метрик
├── pkg                        # Внешние библиотеки/пакеты для общего пользования
│   └── grpc                   # Сгенерированные gRPC файлы
│       ├── metric_grpc.pb.go  # Сгенерированный gRPC код для метрик
│       └── metric.pb.go       # Сгенерированный protobuf код для метрик
└── README.md                  # Документация проекта (описание, инструкции)
```

---

